<div class="content" th:fragment="content" style="height: 100vh; display: flex; flex-direction: column;">
	<div class="sticky-top" style="z-index: 10;">
		<div class="d-flex justify-content-between align-items-center mb-2">
			<div class="d-flex align-items-center gap-2">
		        <a th:href="@{/admin/datasource}" class="btn btn-sm btn-icon-only rounded-circle" title="Back">
		            <i class="bi bi-arrow-left"></i>
		        </a>
				<h3 th:text="${dbConfig.id == null} ? 'Add Datasource' : 'Edit Datasource'"></h3>
		    </div>
			<div class="d-flex gap-2">
				<a class="btn btn-info btn-sm" onclick="testConnection()">
					<i class="bi bi-play-fill"></i> Test Connection
				</a>

			    <button type="submit" form="dbForm" class="btn btn-sm btn-success">
			        <i class="bi bi-save"></i> Save
			    </button>

			    <a th:href="@{/admin/datasource}" class="btn btn-sm btn-secondary">
			        <i class="bi bi-x-circle"></i> Cancel
			    </a>
			</div>
		</div>
	    <hr class="mb-4 mt-2" />
	</div>

	<div style="flex: 1; overflow-y: auto; padding:10px;">
		<!-- Alert test connection -->
		<div id="testResultWrapper" class="alert d-none fade mt-3" role="alert">
		    <span id="testResult"></span>
		</div>
		
		<form id="dbForm" th:action="@{/admin/datasource/save}" th:object="${dbConfig}" method="post" class="needs-validation" novalidate>
	        <input type="hidden" th:field="*{id}" />
	
	        <div class="mb-3">
	            <label for="name" class="form-label">Datasource Name</label>
	            <input type="text" th:field="*{name}" class="form-control" id="name" required />
	            <div class="invalid-feedback">Please provide a datasource name.</div>
	        </div>
	
	        <div class="mb-3">
	            <label for="description" class="form-label">Description</label>
	            <textarea th:field="*{description}" class="form-control" id="description" rows="2" placeholder="Optional description..."></textarea>
	        </div>
	
	        <div class="mb-3">
	            <label for="jdbcUrl" class="form-label">JDBC URL</label>
	            <input type="text" th:field="*{jdbcUrl}" class="form-control" id="jdbcUrl" placeholder="jdbc:mysql://..." required />
	            <div class="invalid-feedback">Please provide a valid JDBC URL.</div>
	        </div>
	
	        <div class="mb-3">
	            <label for="username" class="form-label">Username</label>
	            <input type="text" th:field="*{username}" class="form-control" id="username" required />
	            <div class="invalid-feedback">Please enter username.</div>
	        </div>
	
	        <div class="mb-3">
	            <label for="password" class="form-label">Password</label>
				<input type="hidden" id="existingPassword" name="existingPassword" th:value="${dbConfig.password}" />
	            <input type="password" th:field="*{password}" class="form-control" id="password" th:required="${dbConfig.id == null}" />
	            <div class="invalid-feedback">Please enter password.</div>
	            <small class="form-text text-muted" th:if="${dbConfig.id != null}">Leave blank to keep current password</small>
	        </div>
	
	        <div class="mb-3">
	            <label for="driverClassName" class="form-label">Driver Class Name</label>
	            <input type="text" th:field="*{driverClassName}" class="form-control" id="driverClassName" required />
	            <div class="invalid-feedback">Please enter JDBC driver class name.</div>
	        </div>
	
	        <h4 class="mt-4">Connection Pool Settings</h4>
	        <div class="row g-3">
	            <div class="col-md-4">
	                <label class="form-label">Max Pool Size</label>
	                <input type="number" th:field="*{maxPoolSize}" class="form-control" min="1" />
	            </div>
	
	            <div class="col-md-4">
	                <label class="form-label">Min Idle</label>
	                <input type="number" th:field="*{minIdle}" class="form-control" min="0" />
	            </div>
	
	            <div class="col-md-4">
	                <label class="form-label">Connection Timeout (ms)</label>
	                <input type="number" th:field="*{connectionTimeoutMs}" class="form-control" min="1000" />
	            </div>
	
	            <div class="col-md-4">
	                <label class="form-label">Idle Timeout (ms)</label>
	                <input type="number" th:field="*{idleTimeoutMs}" class="form-control" min="1000" />
	            </div>
	
	            <div class="col-md-4">
	                <label class="form-label">Max Lifetime (ms)</label>
	                <input type="number" th:field="*{maxLifetimeMs}" class="form-control" min="1000" />
	            </div>
	
	            <div class="col-md-4 d-flex align-items-center align-content-center">
					<div class="form-check form-switch toggle-switch d-flex gap-2 align-items-center mt-4">
				        <input class="form-check-input" type="checkbox" th:field="*{active}" id="active">
				        <label class="form-check-label" for="active">Active</label>
				    </div>
	            </div>
	        </div>
	    </form>
	</div>
	<script>
	    // Bootstrap validation (giữ nguyên phần này)
	    (function () {
	        'use strict';
	        var forms = document.querySelectorAll('.needs-validation');
	        Array.prototype.slice.call(forms).forEach(function (form) {
	            form.addEventListener('submit', function (event) {
	                if (!form.checkValidity()) {
	                    event.preventDefault();
	                    event.stopPropagation();
	                }
	                form.classList.add('was-validated');
	            }, false);
	        });
	    })();
		
		function showAlert(message, type = 'success', duration = 3000) {
		    const wrapperEl = document.getElementById('testResultWrapper');
		    const testResultEl = document.getElementById('testResult');

		    testResultEl.textContent = message;
		    wrapperEl.className = `alert alert-${type} mt-3 fade`; // reset class
		    wrapperEl.classList.remove('d-none'); // hiển thị alert

		    // Trigger reflow để fade hoạt động
		    void wrapperEl.offsetWidth;
		    wrapperEl.classList.add('show'); // Bootstrap fade in

		    // Ẩn alert sau duration
		    setTimeout(() => {
		        wrapperEl.classList.remove('show'); // fade out
		        setTimeout(() => {
		            wrapperEl.classList.add('d-none'); // ẩn hoàn toàn sau khi fade out
		        }, 150); // thời gian fade-out match Bootstrap
		    }, duration);
		}

	    // Test connection
		function testConnection() {
		    const form = document.querySelector('form');
		    const formData = new FormData(form);
		    const json = {};

		    formData.forEach((value, key) => {
		        json[key] = value;
		    });
			
			if (!json['password'] || json['password'].trim() === '') {
		        const existingPassword = document.getElementById('existingPassword').value;
		        json['password'] = existingPassword;
		    }

		    fetch('/admin/datasource/test', {
		        method: 'POST',
		        headers: { 'Content-Type': 'application/json' },
		        body: JSON.stringify(json)
		    })
		    .then(res => res.json())
			.then(data => {
			    const testResultEl = document.getElementById('testResult');
			    const wrapperEl = document.getElementById('testResultWrapper');

			    if (data.success) {
			        showAlert('Connection successful!', 'success');
			    } else {
			        showAlert('Connection failed: ' + data.message, 'danger');
			    }

			    wrapperEl.classList.remove('d-none'); // hiện alert
			})
			.catch(err => {
			    showAlert('Error: ' + err.message, 'danger');
			});

		}
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
