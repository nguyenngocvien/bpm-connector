<div class="content" th:fragment="content" style="height: 100vh; display: flex; flex-direction: column;">
	<div class="sticky-top" style="z-index: 10;">
		<div class="d-flex justify-content-between align-items-center mb-2">
			<div class="d-flex align-items-center gap-2">
		        <a th:href="@{/admin/service}" class="btn btn-sm btn-icon-only rounded-circle" title="Back">
		            <i class="bi bi-arrow-left"></i>
		        </a>
		        <h3 class="mb-0" th:text="${serviceConfig.id == null} ? 'Add Service Config' : 'Edit Service Config'"></h3>
		    </div>
			<div class="d-flex gap-2">
			    <a th:if="${serviceConfig.id != null}"
			       th:href="@{'/admin/test?serviceCode=' + ${serviceConfig.serviceCode} + '&serviceType=' + ${serviceConfig.serviceType}}"
			       class="btn btn-sm btn-info">
			        <i class="bi bi-play-fill"></i> Test
			    </a>

			    <a th:if="${serviceConfig.id != null}"
			       th:href="@{'/admin/service/delete/' + ${serviceConfig.id}}"
			       class="btn btn-sm btn-danger"
			       onclick="return confirm('Are you sure to delete this service config?')">
			        <i class="bi bi-trash"></i> Delete
			    </a>

			    <button type="submit" form="serviceForm" class="btn btn-sm btn-success">
			        <i class="bi bi-save"></i> Save
			    </button>

			    <a th:href="@{/admin/service}" class="btn btn-sm btn-secondary">
			        <i class="bi bi-x-circle"></i> Cancel
			    </a>
			</div>
		</div>
	    <hr class="mb-4 mt-2" />
	</div>
 
	<div style="flex: 1; overflow-y: auto; padding:10px;">
	    <form id="serviceForm" th:action="@{/admin/service/save}" th:object="${serviceConfig}" method="post">
			<input type="hidden" th:if="${serviceConfig.id != null}" th:field="*{id}" />
	        <div class="row g-3">
	            <div class="col-md-6">
	                <label class="form-label">Service Code</label>
	                <input type="text" th:field="*{serviceCode}" class="form-control" placeholder="Unique code" required>
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">Service Name</label>
	                <input type="text" th:field="*{serviceName}" class="form-control" placeholder="Service name" required>
	            </div>
				<div class="col-md-6">
				    <label class="form-label">Service Type</label>				
					<select th:field="*{serviceType}" class="form-select" required id="serviceType">
					    <option value="">-- Select Type --</option>
						<option th:each="type : ${T(com.bpm.core.model.service.ServiceType).values()}"
								th:value="${type}"
								th:text="${type.label}">
						</option>
					</select>
				</div>
	            <div class="col-md-6">
	                <label class="form-label">Version</label>
	                <input type="number" th:field="*{version}" class="form-control" min="1" required>
	            </div>
	 
	            <div class="col-md-12">
	                <label class="form-label">Service Description</label>
	                <textarea th:field="*{serviceDescription}" class="form-control" rows="3" placeholder="Optional description"></textarea>
	            </div>
				<div class="col-md-6 mt-3 d-flex gap-4 my-4">
				    <div class="form-check form-switch toggle-switch d-flex gap-2 align-items-center">
				        <input class="form-check-input" type="checkbox" th:field="*{active}" id="active">
				        <label class="form-check-label" for="active">Active</label>
				    </div>
					<div class="form-check form-switch toggle-switch d-flex gap-2 align-items-center">
				        <input class="form-check-input" type="checkbox" th:field="*{logEnabled}" id="logEnabled">
				        <label class="form-check-label" for="logEnabled">Logging</label>
				    </div>
				</div>
	        </div>
	 
	        <!-- DB Config Section -->
			<div id="dbConfigSection" style="display:none;" class="mt-4 position-relative border border-dark rounded p-3 pt-4">
			    <h5 class="section-label">Database Configuration</h6> 
	            <!-- Datasource Dropdown -->
	            <div class="mb-3">
	                <label class="form-label">Datasource</label>
	                <div class="input-group">
	                    <select th:field="*{dbServiceConfig.dbSourceId}" class="form-select" required>
	                        <option value="" disabled>-- Select Datasource --</option>
	                        <option th:each="ds : ${datasourceList}" th:value="${ds.id}" th:text="${ds.name}"></option>
	                    </select>
	                    <a th:href="@{/admin/datasource/add}" class="btn btn-outline-primary" title="Add Datasource">
	                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
	                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
	                        </svg>
	                    </a>
	                </div>
	            </div>
	 
	            <!-- SQL Type -->
	            <div class="mb-3">
	                <label class="form-label">SQL Type</label>
	                <select th:field="*{dbServiceConfig.sqlType}" class="form-select" required>
	                    <option value="" disabled>-- Select SQL Type --</option>
	                    <option th:each="type : ${T(com.bpm.core.model.db.SqlType).values()}"
	                            th:value="${type}" th:text="${type.label}"></option>
	                </select>
	            </div>
				<!-- SQL Statement -->
	            <div class="mb-3">
	                <label class="form-label">SQL Statement</label>
	                <textarea th:field="*{dbServiceConfig.sqlStatement}" class="form-control" rows="3" required></textarea>
	            </div>
				
				<!-- Parameter List -->
	            <div class="mb-4">
	                <div class="d-flex justify-content-between align-items-center mb-2">
	                    <h6 class="mb-0">Parameter List</h6>
	                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addParamRow()">+ Add</button>
	                </div>
	                <table class="table table-dark table-bordered table-sm no-input-border" id="paramTable">
	                    <thead>
	                        <tr>
	                            <th>#</th>
	                            <th>Param Name</th>
	                            <th>Type</th>
	                            <th>Mode</th>
	                            <th>Order</th>
	                            <th></th>
	                        </tr>
	                    </thead>
	                    <tbody id="paramListBody">
	                        <tr th:each="item, iterStat : *{dbServiceConfig.paramList}">
	                            <td th:text="${iterStat.index + 1}"></td>
	                            <td><input type="text" th:field="*{dbServiceConfig.paramList[__${iterStat.index}__].paramName}" class="form-control" /></td>
								<td>
								    <select th:field="*{dbServiceConfig.paramList[__${iterStat.index}__].paramType}" class="form-select">
								        <option th:each="type : ${T(com.bpm.core.model.db.ParamType).values()}"
								                th:value="${type}"
								                th:text="${type.label}">
								        </option>
								    </select>
								</td>		
	                            <td>
	                                <select th:field="*{dbServiceConfig.paramList[__${iterStat.index}__].paramMode}" class="form-select">
	                                    <option value="IN">IN</option>
	                                    <option value="OUT">OUT</option>
	                                </select>
	                            </td>
	                            <td><input type="number" th:field="*{dbServiceConfig.paramList[__${iterStat.index}__].paramOrder}" class="form-control" /></td>
	                            <td><button type="button" class="btn btn-sm btn-outline-danger rounded-xl" onclick="removeRow(this)">Remove</button></td>
	                        </tr>
	                    </tbody>
	                </table>
	            </div>
	 
	            <!-- Output Mapping List -->
	            <div class="mb-4">
	                <div class="d-flex justify-content-between align-items-center mb-2">
	                    <h6 class="mb-0">Output Mapping List</h6>
	                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addMappingRow()">+ Add</button>
	                </div>
	                <table class="table table-dark table-bordered table-sm no-input-border" id="mappingTable">
	                    <thead>
	                        <tr>
	                            <th>#</th>
	                            <th>Column Name</th>
	                            <th>Output Field</th>
	                            <th></th>
	                        </tr>
	                    </thead>
	                    <tbody id="mappingListBody">
	                        <tr th:each="map, iterStat : *{dbServiceConfig.outputMappingList}">
	                            <td th:text="${iterStat.index + 1}"></td>
	                            <td><input type="text" th:field="*{dbServiceConfig.outputMappingList[__${iterStat.index}__].columnName}" class="form-control" /></td>
	                            <td><input type="text" th:field="*{dbServiceConfig.outputMappingList[__${iterStat.index}__].outputField}" class="form-control" /></td>
	                            <td><button type="button" class="btn rounded-xl btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button></td>
	                        </tr>
	                    </tbody>
	                </table>
	            </div>
	 
	            <!-- Advanced Settings -->
	            <div class="row g-3 mb-4">
	                <div class="col-md-4">
	                    <label class="form-label">Timeout (ms)</label>
	                    <input type="number" th:field="*{dbServiceConfig.timeoutMs}" class="form-control" min="0" />
	                </div>
	                <div class="col-md-4">
	                    <label class="form-label">Retry Count</label>
	                    <input type="number" th:field="*{dbServiceConfig.retryCount}" class="form-control" min="0" />
	                </div>
	                <div class="col-md-4">
	                    <label class="form-label">Retry Backoff (ms)</label>
	                    <input type="number" th:field="*{dbServiceConfig.retryBackoffMs}" class="form-control" min="0" />
	                </div>
					<div class="col-md-4 align-content-center">
					    <div class="form-check form-switch toggle-switch d-flex gap-2 align-items-center">
					        <input class="form-check-input" type="checkbox" th:field="*{dbServiceConfig.transactional}" id="transactional">
					        <label class="form-check-label" for="transactional">Transactional</label>
					    </div>
					</div>
					
	                <div class="col-md-4">
	                    <label class="form-label">Fetch Size</label>
	                    <input type="number" th:field="*{dbServiceConfig.fetchSize}" class="form-control" min="1" />
	                </div>
	                <div class="col-md-4">
	                    <label class="form-label">Result Type</label>
	                    <select th:field="*{dbServiceConfig.resultType}" class="form-select">
	                        <option value="LIST">LIST</option>
	                        <option value="SINGLE">SINGLE</option>
	                        <option value="NONE">NONE</option>
	                    </select>
	                </div>
	            </div>
	        </div>
	 
	        <!-- REST Config Section -->
			<div id="restConfigSection" style="display:none;" class="mt-4 position-relative border border-dark rounded p-3 pt-4">
				<h5 class="section-label">REST API Configuration</h6>
	 
	            <!-- Target URL -->
	            <div class="mb-3">
	                <label class="form-label">Target URL</label>
	                <input type="url" th:field="*{restServiceConfig.targetUrl}" class="form-control" placeholder="https://api.example.com">
	            </div>
	 
	            <!-- HTTP Method -->
	            <div class="mb-3">
	                <label class="form-label">HTTP Method</label>
	                <select th:field="*{restServiceConfig.httpMethod}" class="form-select">
	                    <option value="">-- Select Method --</option>
	                    <option value="GET">GET</option>
	                    <option value="POST">POST</option>
	                    <option value="PUT">PUT</option>
	                    <option value="DELETE">DELETE</option>
	                </select>
	            </div>
	 
	            <!-- Content-Type -->
	            <div class="mb-3">
	                <label class="form-label">Content-Type</label>
	                <input type="text" th:field="*{restServiceConfig.contentType}" class="form-control" placeholder="application/json">
	            </div>
	 
	            <!-- Payload Template -->
	            <div class="mb-3">
	                <label class="form-label">Payload Template</label>
	                <textarea th:field="*{restServiceConfig.payloadTemplate}" class="form-control" rows="3" placeholder='{"key":"${value}"}'></textarea>
	            </div>
	 
	            <!-- Response Mapping -->
	            <div class="mb-3">
	                <label class="form-label">Response Mapping (JsonPath)</label>
	                <input type="text" th:field="*{restServiceConfig.responseMapping}" class="form-control" placeholder="$.data.items">
	            </div>
	 
	            <!-- Auth ID (optional dropdown) -->
	            <div class="mb-3">
	                <label class="form-label">Authentication</label>
	                <select th:field="*{restServiceConfig.authId}" class="form-select">
	                    <option value="">-- No Authentication --</option>
	                    <option th:each="auth : ${authList}" th:value="${auth.id}" th:text="${auth.name}"></option>
	                </select>
	            </div>
	 
	            <!-- Header List -->
	            <div class="mt-4">
	                <div class="d-flex justify-content-between align-items-center mb-2">
	                    <h6 class="mb-0">Headers</h6>
	                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addHeaderRow()">+ Add Header</button>
	                </div>
	                <table class="table table-dark table-bordered table-sm no-input-border">
	                    <thead>
	                        <tr>
	                            <th>#</th>
	                            <th>Header Name</th>
	                            <th>Header Value</th>
	                            <th></th>
	                        </tr>
	                    </thead>
	                    <tbody id="headerListBody">
	                        <tr th:each="item, iterStat : *{restServiceConfig.headerList}">
	                            <td th:text="${iterStat.index + 1}"></td>
	                            <td><input type="text" th:field="*{restServiceConfig.headerList[__${iterStat.index}__].name}" class="form-control" /></td>
	                            <td><input type="text" th:field="*{restServiceConfig.headerList[__${iterStat.index}__].value}" class="form-control" /></td>
	                            <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button></td>
	                        </tr>
	                    </tbody>
	                </table>
	            </div>
	 
	            <!-- Query Params -->
	            <div class="mt-4">
	                <div class="d-flex justify-content-between align-items-center mb-2">
	                    <h6 class="mb-0">Query Parameters</h6>
	                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addQueryParamRow()">+ Add Query Param</button>
	                </div>
	                <table class="table table-dark table-bordered table-sm no-input-border">
	                    <thead>
	                        <tr>
	                            <th>#</th>
	                            <th>Param Name</th>
	                            <th>Param Value</th>
	                            <th></th>
	                        </tr>
	                    </thead>
	                    <tbody id="queryParamListBody">
	                        <tr th:each="item, iterStat : *{restServiceConfig.queryParamList}">
	                            <td th:text="${iterStat.index + 1}"></td>
	                            <td><input type="text" th:field="*{restServiceConfig.queryParamList[__${iterStat.index}__].name}" class="form-control" /></td>
	                            <td><input type="text" th:field="*{restServiceConfig.queryParamList[__${iterStat.index}__].value}" class="form-control" /></td>
	                            <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button></td>
	                        </tr>
	                    </tbody>
	                </table>
	            </div>
	 
	            <!-- Path Params -->
	            <div class="mt-4">
	                <div class="d-flex justify-content-between align-items-center mb-2">
	                    <h6 class="mb-0">Path Parameters</h6>
	                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPathParamRow()">+ Add Path Param</button>
	                </div>
	                <table class="table table-dark table-bordered table-sm no-input-border">
	                    <thead>
	                        <tr>
	                            <th>#</th>
	                            <th>Param Name</th>
	                            <th>Param Value</th>
	                            <th></th>
	                        </tr>
	                    </thead>
	                    <tbody id="pathParamListBody">
	                        <tr th:each="item, iterStat : *{restServiceConfig.pathParamList}">
	                            <td th:text="${iterStat.index + 1}"></td>
	                            <td><input type="text" th:field="*{restServiceConfig.pathParamList[__${iterStat.index}__].name}" class="form-control" /></td>
	                            <td><input type="text" th:field="*{restServiceConfig.pathParamList[__${iterStat.index}__].value}" class="form-control" /></td>
	                            <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button></td>
	                        </tr>
	                    </tbody>
	                </table>
	            </div>
	        </div>
	 
	        <!-- Mail Config Section -->
			<div id="mailConfigSection" style="display:none;" class="mt-4 position-relative border border-dark rounded p-3 pt-4">
				<h5 class="section-label">Mail Configuration</h6>
	            <div class="mb-3">
	                <label class="form-label">SMTP Server</label>
	                <input type="text" th:field="*{mailServiceConfig.smtpServer}" class="form-control">
	            </div>
	            <div class="mb-3">
	                <label class="form-label">SMTP Port</label>
	                <input type="number" th:field="*{mailServiceConfig.smtpPort}" class="form-control">
	            </div>
	            <div class="mb-3">
	                <label class="form-label">Email From</label>
	                <input type="email" th:field="*{mailServiceConfig.mailFrom}" class="form-control">
	            </div>
	            <div class="mb-3">
	                <label class="form-label">Email To</label>
	                <input type="email" th:field="*{mailServiceConfig.mailTo}" class="form-control">
	            </div>
	        </div>
	 
	        <!-- File Config Section -->
			<div id="fileConfigSection" style="display:none;" class="mt-4 position-relative border border-dark rounded p-3 pt-4">
						<h5 class="section-label">File Configuration</h6>
	            <div class="mb-3">
	                <label class="form-label">File Path</label>
	                <input type="text" th:field="*{fileServiceConfig.filePath}" class="form-control">
	            </div>
	            <div class="mb-3">
	                <label class="form-label">File Action</label>
	                <input type="text" th:field="*{fileServiceConfig.fileAction}" class="form-control">
	            </div>
	            <div class="mb-3">
	                <label class="form-label">File Format</label>
	                <input type="text" th:field="*{fileServiceConfig.fileFormat}" class="form-control">
	            </div>
	        </div>
	    </form>
	</div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const serviceTypeField = document.getElementById('serviceType');
            const dbSection = document.getElementById('dbConfigSection');
            const restSection = document.getElementById('restConfigSection');
            const mailSection = document.getElementById('mailConfigSection');
            const fileSection = document.getElementById('fileConfigSection');
 
            function updateSections() {
                const type = serviceTypeField.value;
                dbSection.style.display = type === 'DB' ? 'block' : 'none';
                restSection.style.display = type === 'REST' ? 'block' : 'none';
                mailSection.style.display = type === 'MAIL' ? 'block' : 'none';
                fileSection.style.display = type === 'FILE' ? 'block' : 'none';
            }
 
            serviceTypeField.addEventListener('change', updateSections);
            updateSections(); // initial call
        });
    </script>
	<script th:inline="javascript">
	    /*<![CDATA[*/
	    const paramTypes = /*[[${T(com.bpm.core.model.db.ParamType).values()}]]*/ [];
	    /*]]>*/
	</script>
	<script>
		function addParamRow() {
		    const tbody = document.getElementById("paramListBody");
		    const index = tbody.children.length;
		
		    const row = document.createElement("tr");
		
		    // tạo select paramType từ enum
		    let selectHtml = `<select name="dbServiceConfig.paramList[${index}].paramType" class="form-select">`;
		    paramTypes.forEach(type => {
		        selectHtml += `<option value="${type}">${type}</option>`;
		    });
		    selectHtml += "</select>";
		
		    row.innerHTML = `
		        <td>${index + 1}</td>
		        <td><input type="text" name="dbServiceConfig.paramList[${index}].paramName" class="form-control" /></td>
		        <td>${selectHtml}</td>
		        <td>
		            <select name="dbServiceConfig.paramList[${index}].paramMode" class="form-select">
		                <option value="IN">IN</option>
		                <option value="OUT">OUT</option>
		            </select>
		        </td>
		        <td><input type="number" name="dbServiceConfig.paramList[${index}].paramOrder" class="form-control" /></td>
		        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button></td>
		    `;
		
		    tbody.appendChild(row);
		}

	
		function addMappingRow() {
		    const tbody = document.getElementById("mappingListBody");
		    const index = tbody.children.length;
	
		    const row = document.createElement("tr");
		    row.innerHTML = `
		        <td>${index + 1}</td>
		        <td><input type="text" name="dbServiceConfig.outputMappingList[${index}].columnName" class="form-control" /></td>
		        <td><input type="text" name="dbServiceConfig.outputMappingList[${index}].outputField" class="form-control" /></td>
		        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button></td>
		    `;
		    tbody.appendChild(row);
		}
	
		function removeRow(button) {
		    const row = button.closest("tr");
		    row.remove();
	
		    // Re-index lại thứ tự hiển thị số thứ tự (#) nếu cần
		    reindexTable("paramListBody");
		    reindexTable("mappingListBody");
		}
	
		function reindexTable(tbodyId) {
		    const tbody = document.getElementById(tbodyId);
		    Array.from(tbody.children).forEach((row, index) => {
		        row.children[0].innerText = index + 1; // cập nhật cột #
		    });
		}
	</script>
	<script>
		// ==== HEADER LIST ====
		function addHeaderRow() {
		    const tbody = document.getElementById("headerListBody");
		    const index = tbody.children.length;
	
		    const row = document.createElement("tr");
		    row.innerHTML = `
		        <td>${index + 1}</td>
		        <td><input type="text" name="restServiceConfig.headerList[${index}].name" class="form-control" /></td>
		        <td><input type="text" name="restServiceConfig.headerList[${index}].value" class="form-control" /></td>
		        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button></td>
		    `;
		    tbody.appendChild(row);
		    reindexTable("headerListBody");
		}
	
		// ==== QUERY PARAMS ====
		function addQueryParamRow() {
		    const tbody = document.getElementById("queryParamListBody");
		    const index = tbody.children.length;
	
		    const row = document.createElement("tr");
		    row.innerHTML = `
		        <td>${index + 1}</td>
		        <td><input type="text" name="restServiceConfig.queryParamList[${index}].name" class="form-control" /></td>
		        <td><input type="text" name="restServiceConfig.queryParamList[${index}].value" class="form-control" /></td>
		        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button></td>
		    `;
		    tbody.appendChild(row);
		    reindexTable("queryParamListBody");
		}
	
		// ==== PATH PARAMS ====
		function addPathParamRow() {
		    const tbody = document.getElementById("pathParamListBody");
		    const index = tbody.children.length;
	
		    const row = document.createElement("tr");
		    row.innerHTML = `
		        <td>${index + 1}</td>
		        <td><input type="text" name="restServiceConfig.pathParamList[${index}].name" class="form-control" /></td>
		        <td><input type="text" name="restServiceConfig.pathParamList[${index}].value" class="form-control" /></td>
		        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">Remove</button></td>
		    `;
		    tbody.appendChild(row);
		    reindexTable("pathParamListBody");
		}
	
		// ==== REMOVE ROW (chung) ====
		function removeRow(button) {
		    const row = button.closest("tr");
		    const tbody = row.parentNode;
		    row.remove();
		    reindexTable(tbody.id);
		}
	
		// ==== RE-INDEX TABLE (#) ====
		function reindexTable(tbodyId) {
		    const tbody = document.getElementById(tbodyId);
		    Array.from(tbody.children).forEach((row, index) => {
		        row.children[0].innerText = index + 1;
		    });
		}
	</script>
</div>